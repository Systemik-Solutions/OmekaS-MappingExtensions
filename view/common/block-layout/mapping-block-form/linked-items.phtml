<?php

/** @var \Laminas\View\Renderer\PhpRenderer $this */
/** @var array $data */
/** @var \Laminas\Form\Form $form */

$services = $this->getHelperPluginManager()->getServiceLocator();
$formElementManager = $services->get('FormElementManager');
$view = $this;

// 1) Checkbox — "Map linked items instead" (unchecked by default)
$mapLinkedItems = new \Laminas\Form\Element\Checkbox('o:block[__blockIndex__][o:data][map_linked_items]');
$mapLinkedItems->setOptions([
    'label'              => $view->translate('Map linked items instead'),
    'use_hidden_element' => true,
    'checked_value'      => '1',
    'unchecked_value'    => '0',
]);
$mapLinkedItems->setValue(!empty($data['map_linked_items']) ? '1' : '0');
$form->add($mapLinkedItems);


// 2) Dropdown — "Property" (multiple PropertySelect)
$linkedProps = $formElementManager->get(\Omeka\Form\Element\PropertySelect::class);
$linkedProps->setName('o:block[__blockIndex__][o:data][linked_properties]');
$linkedProps->setOptions([
    'label'              => $view->translate('Property'),
    'empty_option'       => '',
    'term_as_value'      => true,
    'use_hidden_element' => true,
]);
$linkedProps->setAttributes([
    'multiple'         => true,
    'class'            => 'chosen-select linked-prop-select',
    'data-placeholder' => $view->translate('Select one or more properties…'),
    'value'            => $data['linked_properties'] ?? [],
]);
$linkedProps->setValue($data['linked_properties'] ?? []);
$form->add($linkedProps);

// 3) Dropdown — "Display properties in Popup" (multiple PropertySelect)
$popupProps = $formElementManager->get(\Omeka\Form\Element\PropertySelect::class);
$popupProps->setName('o:block[__blockIndex__][o:data][popup_display_properties]');
$popupProps->setOptions([
    'label'              => $view->translate('Display properties in Popup'),
    'empty_option'       => '',
    'term_as_value'      => true,
    'use_hidden_element' => true,
]);
$popupProps->setAttributes([
    'multiple'         => true,
    'class'            => 'chosen-select popup-prop-select',
    'data-placeholder' => $view->translate('Select one or more properties…'),
    'value'            => $data['popup_display_properties'] ?? [],
]);
$popupProps->setValue($data['popup_display_properties'] ?? []);
$form->add($popupProps);

// Hidden input to store popup property order 
$popupOrder = new \Laminas\Form\Element\Hidden('o:block[__blockIndex__][o:data][popup_display_properties__order]');
$popupOrder->setValue(implode(',', $data['popup_display_properties'] ?? []));
$form->add($popupOrder);
?>

<a href="#" class="collapse">
    <h4><?= $this->translate('Linked Items'); ?></h4>
</a>
<div class="collapsible linked-items-settings">
    <?= $this->formRow($form->get('o:block[__blockIndex__][o:data][map_linked_items]')); ?>
    <?= $this->formRow($linkedProps); ?>
    <?= $this->formRow($popupProps); ?>
    <?= $this->formRow($form->get('o:block[__blockIndex__][o:data][popup_display_properties__order]')); // hidden 
    ?>
</div>

<script>
(function($){
    // Sync hidden order field from the popup multi-select
    function syncPopupOrder($select) {
        const name = $select.attr('name') || '';
        if (name.indexOf('][popup_display_properties]') === -1) return;

        // Strip trailing [] from the multi-select name
        const baseName = name.replace(/\[\]$/, '');

        // Build the hidden field's name from the base
        const hiddenName = baseName.replace(
            '][popup_display_properties]',
            '][popup_display_properties__order]'
        );

        // Find the hidden input
        const $hidden = $('input[name="' + hiddenName.replace(/([\[\]])/g, '\\$1') + '"]');
        if (!$hidden.length) return;

        // Selected values (in current DOM order)
        const selected = $select.val() || [];

        // Existing order (comma-separated)
        let order = ($hidden.val() || '').split(',').filter(Boolean);

        // Prune deselected
        order = order.filter(v => selected.indexOf(v) !== -1);
        // Append newly selected at the end
        selected.forEach(v => { if (order.indexOf(v) === -1) order.push(v); });

        $hidden.val(order.join(','));
    }

    function initRelProps(scope) {
        $(scope).find('select.linked-prop-select, select.popup-prop-select').each(function() {
            const $s = $(this);
            if ($s.data('ngChosenInit')) return;

            if ($.fn.chosen) {
                try {
                    $s.chosen({
                        width: '100%',
                        include_group_label_in_selected: true,
                        placeholder_text_multiple:
                            $s.data('placeholder') || 'Select one or more properties…',
                    });
                    $s.data('ngChosenInit', 1);
                } catch (e) {
                    console.error('MappingPlus: Chosen init failed', e);
                }
            }

            // Only track the popup properties select
            if ($s.hasClass('popup-prop-select')) {
                // Initial sync (covers the case where user doesn't touch the control)
                syncPopupOrder($s);

                // Keep synced on any change
                $s.off('change.mpPopupOrder').on('change.mpPopupOrder', function() {
                    syncPopupOrder($s);
                });
            }
        });
    }

    $(function(){ initRelProps(document); });
    $(document)
        .on('o:form-loaded o:block-added o:form-updated o:collection-add', function(_e, ctx) {
            initRelProps(ctx || document);
        });

})(jQuery);
</script>
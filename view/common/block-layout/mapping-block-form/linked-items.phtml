<?php

/** @var \Laminas\View\Renderer\PhpRenderer $this */
/** @var array $data */
/** @var \Laminas\Form\Form $form */

$services = $this->getHelperPluginManager()->getServiceLocator();
$formElementManager = $services->get('FormElementManager');
$view = $this;


// 1) Checkbox — "Map linked items instead" (unchecked by default)
$mapLinkedItems = new \Laminas\Form\Element\Checkbox('o:block[__blockIndex__][o:data][map_linked_items]');
$mapLinkedItems->setOptions([
    'label'              => $view->translate('Map linked items instead'),
    'use_hidden_element' => true,
    'checked_value'      => '1',
    'unchecked_value'    => '0',
]);
$mapLinkedItems->setValue(!empty($data['map_linked_items']) ? '1' : '0');
$form->add($mapLinkedItems);


// 2) Dropdown — "Property" (multiple PropertySelect)
$linkedProps = $formElementManager->get(\Omeka\Form\Element\PropertySelect::class);
$linkedProps->setName('o:block[__blockIndex__][o:data][linked_properties]');
$linkedProps->setOptions([
    'label'              => $view->translate('Property'),
    'empty_option'       => '',
    'term_as_value'      => true,
    'use_hidden_element' => true,
]);
$linkedProps->setAttributes([
    'multiple'         => true,
    'class'            => 'chosen-select linked-prop-select',
    'data-placeholder' => $view->translate('Select one or more properties…'),
    'value'            => $data['linked_properties'] ?? [],
]);
$linkedProps->setValue($data['linked_properties'] ?? []);
$form->add($linkedProps);


// 3) Display properties in Popup — ONE property per row (order = row order)
$popupBase = $formElementManager->get(\Omeka\Form\Element\PropertySelect::class);
$popupBase->setOptions([
    'label'              => $view->translate('Display properties in Popup'),
    'empty_option'       => '',
    'term_as_value'      => true,
    'use_hidden_element' => true,
]);
$popupBase->setAttributes([
    'class'            => 'chosen-select popup-prop-select',
    'data-placeholder' => $view->translate('Select a property…'),
]);

// The saved ordered list of terms
$popupValues = $data['popup_display_properties'] ?? [];
// If none saved, show one empty row
if (!$popupValues) {
    $popupValues = [''];
}

?>

<a href="#" class="collapse">
    <h4><?= $this->translate('Linked Items'); ?></h4>
</a>
<div class="collapsible linked-items-settings">
    <?= $this->formRow($form->get('o:block[__blockIndex__][o:data][map_linked_items]')); ?>
    <?= $this->formRow($linkedProps); ?>

    <div class="popup-props-wrapper">
        <div class="popup-props-rows">
            <?php foreach ($popupValues as $val): ?>
                <?php
                $rowEl = clone $popupBase;
                $rowEl->setName('o:block[__blockIndex__][o:data][popup_display_properties][]');
                $rowEl->setValue($val);
                ?>
                <div class="popup-prop-row" style="display: flex;">
                    <?= $this->formRow($rowEl); ?>
                    <button type="button"
                        class="button popup-prop-remove"
                        style="margin-left:.5rem;margin-top:1.2%;max-height:20px">×</button>
                </div>
            <?php endforeach; ?>

            <?php
            // Hidden template for new rows
            $tplEl = clone $popupBase;
            $tplEl->setName('o:block[__blockIndex__][o:data][popup_display_properties][]');
            $tplEl->setValue(''); // empty by default

            // Build the same HTML structure as above
            $tplHtml = '<div class="popup-prop-row" style="display: flex;">'
                . $this->formRow($tplEl)
                . '<button type="button" class="button popup-prop-remove" '
                . 'style="margin-left:.5rem;margin-top:1.2%;max-height:20px">×</button>'
                . '</div>';
            ?>
            <span class="popup-prop-template"
                data-template="<?= $this->escapeHtml($tplHtml); ?>"
                style="display:none;"></span>
        </div>

        <button type="button"
            class="button popup-prop-add"
            style="margin-top:.5rem;">
            + <?= $this->escapeHtml($this->translate('Add property')) ?>
        </button>
    </div>
</div>

<script>
    (function($) {
        function initRelProps(scope) {
            $(scope).find('select.linked-prop-select, select.popup-prop-select').each(function() {
                const $s = $(this);
                if ($s.data('ngChosenInit')) return;

                if ($.fn.chosen) {
                    try {
                        $s.chosen({
                            width: '100%',
                            include_group_label_in_selected: true,
                            placeholder_text_multiple: $s.data('placeholder') || 'Select one or more properties…',
                            placeholder_text_single: $s.data('placeholder') || 'Select a property…'
                        });
                        $s.data('ngChosenInit', 1);
                    } catch (e) {
                        console.error('MappingPlus: Chosen init failed', e);
                    }
                }
            });
        }

        function wirePopupRows(scope) {
            const $scope = $(scope);
            if ($scope.data('popup-rows-wired')) return;
            $scope.data('popup-rows-wired', true);

            // Add new row
            $scope.on('click', '.popup-prop-add', function(e) {
                e.preventDefault();

                const $wrapper = $scope.find('.popup-props-rows').first();
                const $tmpl = $wrapper.find('.popup-prop-template').first();
                if (!$tmpl.length) return;

                // 1) Get the raw HTML from data-template
                let tplHtml = $tmpl.attr('data-template') || '';
                if (!tplHtml) return;

                // 2) Find this block's real index (e.g. o:block[3]…)
                const anyName = $scope.find('[name^="o:block["]').first().attr('name') || '';
                const m = anyName.match(/^o:block\[(\d+)]/);
                const blockIndex = m ? m[1] : '__blockIndex__';

                // 3) Replace __blockIndex__ placeholders with the real index
                tplHtml = tplHtml.replace(/__blockIndex__/g, blockIndex);

                // 4) Turn into a DOM node and insert before the template span
                const $row = $(tplHtml);
                $row.insertBefore($tmpl);

                // 5) Init Chosen for the new select
                const $sel = $row.find('select.popup-prop-select');
                if ($.fn.chosen && $sel.length) {
                    try {
                        $sel.chosen({
                            width: '100%',
                            include_group_label_in_selected: true,
                            placeholder_text_single: $sel.data('placeholder') || 'Select a property…'
                        });
                        $sel.data('ngChosenInit', 1);
                    } catch (err) {
                        console.error('MappingPlus: Chosen init failed on new row', err);
                    }
                }
            });

            // Remove row (unchanged)
            $scope.on('click', '.popup-prop-remove', function(e) {
                e.preventDefault();
                const $row = $(this).closest('.popup-prop-row');
                $row.remove();
            });
        }
        $(function() {
            initRelProps(document);
            $('.linked-items-settings').each(function() {
                wirePopupRows(this);
            });
        });

        $(document)
            .on('o:form-loaded o:block-added o:form-updated o:collection-add', function(_e, ctx) {
                const scope = ctx || document;
                initRelProps(scope);
                $(scope).find('.linked-items-settings').each(function() {
                    wirePopupRows(this);
                });
            });
    })(jQuery);
</script>
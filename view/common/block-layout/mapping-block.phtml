<?php
if ($isTimeline) {
    $this->headLink()->appendStylesheet('https://cdn.knightlab.com/libs/timeline3/latest/css/timeline.css');
    $this->headScript()->appendFile('https://cdn.knightlab.com/libs/timeline3/latest/js/timeline.js');
    $this->headLink()->appendStylesheet($this->assetUrl('css/timeline.css', 'Mapping'));
}

// Set the classes for the mapping block container div.
$classes = ['mapping-block'];
if ($isTimeline) {
    $classes[] = 'timeline';
    $classes[] = $data['timeline']['timenav_position'];
    if ('full_width_below' === $data['timeline']['timenav_position']) {
        $classes[] = 'timenav-full-width-below';
    }
    if ('full_width_above' === $data['timeline']['timenav_position']) {
        $classes[] = 'timenav-full-width-above';
    }
}

// Build legend entries from configured group colors
$legendEntries = [];
$groupMode = $data['group_by_control']['group-by-select'] ?? '';
$groupByPropertyValue = $data['group_by_control']['property_value'] ?? '';
$rows      = $data['node_colors']['rows'] ?? [];


if ($groupMode && is_array($rows) && $rows) {
    try {
        foreach ($rows as $row) {
            $color = $row['color'] ?? '';
            if (!$color) continue;

            if ($groupMode === 'resource_class' && !empty($row['resource_class'])) {
                try {
                    $rc = $this->api()->read('resource_classes', (int)$row['resource_class'])->getContent();
                    $label = $rc ? $rc->label() : ('Class #' . (int)$row['resource_class']);
                } catch (\Throwable $e) {
                    $label = 'Class #' . (int)$row['resource_class'];
                }
                $legendEntries[] = ['label' => $label, 'color' => $color];
            }

            if ($groupMode === 'resource_template' && !empty($row['resource_template'])) {
                try {
                    $rt = $this->api()->read('resource_templates', (int)$row['resource_template'])->getContent();
                    $label = $rt ? $rt->label() : ('Template #' . (int)$row['resource_template']);
                } catch (\Throwable $e) {
                    $label = 'Template #' . (int)$row['resource_template'];
                }
                $legendEntries[] = ['label' => $label, 'color' => $color];
            }

    
            if ($groupMode === 'property_value' && $groupByPropertyValue !== '' && !empty($row['property_text'])) {
                $propLabel = $groupByPropertyValue;
                
                try {
                    // Try to read the property by term (not ID)
                    $prop = $this->api()->searchOne('properties', ['term' => $groupByPropertyValue])->getContent();
                    if ($prop) {
                        $propLabel = $prop->label();
                    }
                } catch (\Throwable $e) {
                    // fall back to the term itself
                }

                $textLabel = trim((string) $row['property_text']);
                $label = sprintf('%s: %s', ucfirst($propLabel), $textLabel);

                $legendEntries[] = [
                    'label' => $label,
                    'color' => $color,
                ];
            }
        }
    } catch (\Throwable $ignored) {
    }
}

$legendId = 'mapping-legend-' . uniqid();
?>
<div class="<?php echo implode(' ', $classes); ?>">

    <?php if ($isTimeline): ?>
        <div class='mapping-timeline' style="height: 500px"
            data-data="<?php echo $this->escapeHtml(json_encode($timelineData)); ?>"
            data-options="<?php echo $this->escapeHtml(json_encode($timelineOptions)); ?>"></div>
    <?php endif; ?>

    <div class="mapping-map" style="height:500px;"
        data-data="<?php echo $this->escapeHtml(json_encode($data)); ?>"
        data-disable-clustering="<?php echo $this->siteSetting('mapping_disable_clustering') ? '1' : '0'; ?>"
        data-basemap-provider="<?php echo $this->escapeHtml($this->siteSetting('mapping_basemap_provider')); ?>"
        data-features-url="<?php echo $this->escapeHtml($this->url('site/mapping', ['controller' => 'index', 'action' => 'get-features'], true)); ?>"
        data-feature-popup-content-url="<?php echo $this->escapeHtml($this->url('site/mapping', ['controller' => 'index', 'action' => 'get-feature-popup-content'], true)); ?>"
        data-items-query="<?php echo $this->escapeHtml(json_encode($itemsQuery)); ?>"
        data-features-query="<?php echo $this->escapeHtml(json_encode($featuresQuery)); ?>">
    </div>

    <?php if (!empty($legendEntries)): ?>
        <div id="<?php echo $legendId; ?>" class="mapping-legend"
            style="position: absolute;
                    left: 10px;
                    bottom: 10px;
                    z-index: 1000;
                    background: #fff;
                    border: 1px solid rgba(0, 0, 0, .15);
                    padding: 8px 10px;
                    max-width: 240px;
                    line-height: 1.3;
                    box-shadow: 0 1px 10px rgba(0, 0, 0, 0.4);
                    border-radius: 10px;
                    font-size: 17px;
                    background-color: white;">
        </div>
    <?php endif; ?>

</div>

<script>
    (function() {
        // Only build legend if we have entries
        const legendEntries = <?php echo json_encode($legendEntries, JSON_UNESCAPED_UNICODE); ?>;
        if (!legendEntries || !legendEntries.length) return;

        const el = document.getElementById('<?php echo $legendId; ?>');
        if (!el) return;

        const esc = s => String(s)
            .replace(/&/g, '&amp;').replace(/</g, '&lt;')
            .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        let html = '<div style="font-weight:600;margin-bottom:6px;"></div>';

        legendEntries.forEach(({
            label,
            color
        }) => {
            // Use the same pin shape as markers
            const pinSvg =
                '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" ' +
                'style="display:block;">' +
                '<path fill="' + esc(color) + '" stroke="#333" stroke-width="1.2" d="M12 2C8 2 5 5.1 5 9c0 4.6 7 13 7 13s7-8.4 7-13c0-3.9-3-7-7-7z"/>' +
                '<circle cx="12" cy="9" r="3" fill="white"/>' +
                '</svg>';

            html += '<div class="legend-row" style="display:flex;align-items:center;gap:8px;margin:4px 0;">' +
                '<span class="legend-icon" aria-hidden="true" style="width:18px;height:18px;display:inline-block;">' + pinSvg + '</span>' +
                '<span class="legend-label" style="flex:1 1 auto;">' + esc(label) + '</span>' +
                '</div>';
        });

        el.innerHTML = html;
    })();
</script>